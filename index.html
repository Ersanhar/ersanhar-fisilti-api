<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FÄ±sÄ±ltÄ±">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRsSxc8SxbHTEsSIsInNob3J0X25hbWUiOiJGxLFzxLFsdMSxIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEhKbFkzUWdkMmxrZEdnOUlqRXlPQ0luSUdobGFXZG9kRDBpTVRJNElpQm1hV3hzUFNJak5qTTJObVl4SWk4K1BIUmxlSFFnZUQwaU5qUWlJSGs5SWpZMElpQjBlWFIwTFdGdVkyaHZjajBpYldsa1pHeGxJaUJrZVQwaUxqTmxiU0luSUdadmJuUXRabUZ0YVd4NVBTSkJjbWxoYkNJZ1ptOXVkQzF6YVhwbFBTSXlOQ0luSUdacGJHdzlJaU5tWm1abVptWWlQa1k4TDNSbGVIUStQQzl6ZG1jKyIsInNpemVzIjoiMTI4eDEyOCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <title>FÄ±sÄ±ltÄ± - AI Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&family=Dancing+Script&family=Merriweather&family=Orbitron&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
            transition: background 1.5s ease-in-out;
            -webkit-overflow-scrolling: touch;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 640px) {
            .main-container {
                height: 100vh;
                height: 100dvh;
                display: flex;
                flex-direction: column;
            }
            
            .chat-container {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-header {
                position: sticky;
                top: 0;
                z-index: 10;
                flex-shrink: 0;
            }
            
            .mobile-input-area {
                position: sticky;
                bottom: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                flex-shrink: 0;
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }
            
            .mobile-keyboard-safe {
                padding-bottom: env(keyboard-inset-height, 0px);
            }
            
            .app-container {
                border-radius: 0;
                height: 100vh;
                height: 100dvh;
                max-width: none;
            }
        }
        
        /* Touch-friendly button sizes */
        @media (max-width: 768px) {
            button {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                touch-action: manipulation;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* Landscape mobile optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .fisilti-tagline {
                display: none;
            }
            
            .logo-container {
                padding: 0.5rem 0;
            }
        }
        
        /* PWA specific styles */
        @media (display-mode: standalone) {
            .pwa-padding {
                padding-top: env(safe-area-inset-top, 0px);
            }
        }
        
        /* Improved scroll behavior */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* Loading states for mobile */
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Haptic feedback simulation */
        .haptic-feedback {
            transition: transform 0.1s ease;
        }
        
        .haptic-feedback:active {
            transform: scale(0.95);
        }
        
        .typing-animation {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6366f1;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-animation:nth-child(1) { animation-delay: -0.32s; }
        .typing-animation:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .message-enter {
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #fceff9 0%, #dbeafe 100%);
        }
        
        .chat-container {
            height: 100%;
            max-height: 600px;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes glowFade {
            0% {
                opacity: 0.8;
                transform: scale(0.98);
                box-shadow: 0 0 0px transparent;
            }
            50% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 12px #f9a8d4;
            }
            100% {
                opacity: 0.9;
                box-shadow: 0 0 0px transparent;
            }
        }
        
        .fisilti-logo {
            animation: glowFade 2.5s ease-in-out;
        }
        
        .glow-once {
            animation: glowFade 2.5s ease-in-out;
        }
        
        .character-avatar {
            animation: glowFade 1s ease-out;
        }
        
        @keyframes whisperFade {
            0% { opacity: 0; transform: translateY(5px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0.8; }
        }
        
        .fisilti-tagline {
            animation: whisperFade 2s ease-in-out;
        }
        
        .lavender-theme {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0c3fc 100%);
            transition: background 1s ease-in-out;
        }
        
        .lavender-glow {
            box-shadow: 0 0 12px #c084fc;
            transition: box-shadow 1s ease-in-out;
        }
        
        /* Bilge Ã–ÄŸretmen â€“ Sakin YeÅŸil */
        .sage-theme {
            background: linear-gradient(135deg, #e6f4ea 0%, #cce3d4 100%);
            transition: background 1s ease-in-out;
        }

        /* Komik ArkadaÅŸ â€“ NeÅŸeli SarÄ± */
        .sunny-theme {
            background: linear-gradient(135deg, #fff9db 0%, #ffe8a3 100%);
            transition: background 1s ease-in-out;
        }

        /* Teknik Uzman â€“ Serin Gri */
        .steel-theme {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transition: background 1s ease-in-out;
        }
        
        .sage-glow {
            box-shadow: 0 0 12px #86efac;
            transition: box-shadow 1s ease-in-out;
        }

        .sunny-glow {
            box-shadow: 0 0 12px #fde047;
            transition: box-shadow 1s ease-in-out;
        }

        .steel-glow {
            box-shadow: 0 0 12px #94a3b8;
            transition: box-shadow 1s ease-in-out;
        }
        
        .ice-theme {
            background: linear-gradient(135deg, #e0f7ff 0%, #cce5ff 100%);
            transition: background 1s ease-in-out;
        }
        
        .ice-glow {
            box-shadow: 0 0 12px #7dd3fc;
            transition: box-shadow 1s ease-in-out;
        }
        
        @keyframes poeticFade {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }

        .poetic-fade { animation: poeticFade 0.6s ease-out; }
        .bounce-in { animation: bounceIn 0.5s ease-out; }
        
        /* Character-specific bubble styles */
        /* Bal BÃ¶ceÄŸi */
        .bubble-balbocegi {
            background-color: #fdf2f8;
            color: #831843;
        }

        /* Bilge Ã–ÄŸretmen */
        .bubble-bilge {
            background-color: #e6f4ea;
            color: #065f46;
        }

        /* Komik ArkadaÅŸ */
        .bubble-komik {
            background-color: #fff9db;
            color: #92400e;
        }

        /* Teknik Uzman */
        .bubble-teknik {
            background-color: #e2e8f0;
            color: #1e293b;
        }

        /* DJ Penguen */
        .bubble-dj {
            background-color: #e0f7ff;
            color: #0c4a6e;
        }

        /* RÃ¼zgar Åairi */
        .bubble-ruzgarsairi {
            background-color: #f0fdf4;
            color: #14532d;
        }

        /* KÄ±vÄ±lcÄ±m */
        .bubble-kivilcim {
            background-color: #fef2f2;
            color: #991b1b;
        }

        /* Toprak Anne */
        .bubble-toprakanne {
            background-color: #fefce8;
            color: #713f12;
        }

        /* Sessiz Kodcu */
        .bubble-sessizkodcu {
            background-color: #f1f5f9;
            color: #0f172a;
        }

        /* Hayal Perdesi */
        .bubble-hayalperdesi {
            background-color: #faf5ff;
            color: #581c87;
        }
        
        /* Character-specific fonts */
        .font-balbocegi { font-family: 'Dancing Script', cursive; }
        .font-bilge { font-family: 'Merriweather', serif; }
        .font-komik { font-family: 'Comic Neue', cursive; }
        .font-teknik { font-family: 'Roboto Mono', monospace; }
        .font-dj { font-family: 'Orbitron', sans-serif; }
        .font-ruzgarsairi { font-family: 'Dancing Script', cursive; font-style: italic; }
        .font-kivilcim { font-family: 'Orbitron', sans-serif; font-weight: bold; }
        .font-toprakanne { font-family: 'Merriweather', serif; font-weight: 500; }
        .font-sessizkodcu { font-family: 'Roboto Mono', monospace; font-size: 0.9em; }
        .font-hayalperdesi { font-family: 'Dancing Script', cursive; font-size: 1.1em; }
        
        /* Poetic Scene Backgrounds */
        .scene-flower-whisper {
            background: linear-gradient(135deg, #fdf2f8 0%, #f3e8ff 25%, #e0f2fe 50%, #ecfdf5 75%, #fef7cd 100%);
            transition: background 2s ease-in-out;
        }
        
        .scene-moon-dream {
            background: radial-gradient(ellipse at center, #1e1b4b 0%, #312e81 30%, #4c1d95 60%, #581c87 100%);
            transition: background 2s ease-in-out;
        }
        
        .scene-winged-words {
            background: linear-gradient(45deg, #fef3c7 0%, #ddd6fe 20%, #bfdbfe 40%, #a7f3d0 60%, #fed7aa 80%, #fecaca 100%);
            background-size: 400% 400%;
            animation: floatingWords 8s ease-in-out infinite;
            transition: background 2s ease-in-out;
        }
        
        @keyframes floatingWords {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }
        
        @keyframes flutter {
            0% { transform: translateY(2px); opacity: 0.8; }
            50% { transform: translateY(-2px); opacity: 1; }
            100% { transform: translateY(2px); opacity: 0.8; }
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0px transparent; }
            50% { box-shadow: 0 0 12px #f87171; }
            100% { box-shadow: 0 0 0px transparent; }
        }

        .flutter { animation: flutter 2s ease-in-out infinite; }
        .pulse-glow { animation: pulseGlow 1.5s ease-in-out infinite; }

        /* GitHub deployment status indicator */
        .deployment-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
        }

        .status-online { background: rgba(34, 197, 94, 0.8); }
        .status-offline { background: rgba(239, 68, 68, 0.8); }
    </style>
</head>
<body class="gradient-bg min-h-full font-sans">
    <!-- Deployment Status Indicator -->
    <div id="deploymentStatus" class="deployment-status status-offline">
        ğŸ”„ BaÄŸlantÄ± kontrol ediliyor...
    </div>

    <div class="min-h-full flex items-center justify-center p-0 sm:p-4">
        <div class="bg-white rounded-none sm:rounded-2xl shadow-2xl w-full max-w-md sm:max-w-lg app-container main-container">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-3 sm:p-4 rounded-t-none sm:rounded-t-2xl mobile-header pwa-padding">
                <!-- FÄ±sÄ±ltÄ± Logo -->
                <div class="flex items-center space-x-3 mb-2 logo-container">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full shadow-md fisilti-logo bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-lg sm:text-xl font-bold touch-target">
                        F
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-xl font-semibold text-white tracking-wide">FÄ±sÄ±ltÄ±</h1>
                        <p class="text-xs sm:text-sm text-white opacity-80 italic fisilti-tagline">Her karakter bir ses, her yanÄ±t bir duygudur.</p>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-1 text-xs sm:text-sm opacity-90">
                        <div id="connectionStatus" class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                        <span id="connectionText">BaÄŸlanÄ±yor...</span>
                    </div>
                    <button id="settingsBtn" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-colors touch-target haptic-feedback">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatContainer" class="chat-container overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4 smooth-scroll">
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="px-3 sm:px-4 pb-2 hidden">
                <div class="flex items-start space-x-2">
                    <div id="typingAvatar" class="w-6 h-6 sm:w-8 sm:h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-xs sm:text-sm">
                        ğŸ¤–
                    </div>
                    <div class="bg-gray-100 rounded-2xl rounded-tl-sm p-2 sm:p-3">
                        <div class="flex space-x-1">
                            <div class="typing-animation"></div>
                            <div class="typing-animation"></div>
                            <div class="typing-animation"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Character Selector -->
            <div class="px-3 sm:px-4 py-2 border-t border-gray-100">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2 text-xs sm:text-sm">
                        <span class="text-gray-600">Karakter:</span>
                        <select id="characterSelect" class="border border-gray-300 rounded px-2 py-1 text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 touch-target">
                            <option value="default">ğŸ¤– VarsayÄ±lan AI</option>
                            <option value="BalBocegi">ğŸŒ¸ Bal BÃ¶ceÄŸi</option>
                            <option value="BilgeOgretmen">ğŸ§™â€â™‚ï¸ Bilge Ã–ÄŸretmen</option>
                            <option value="KomikArkadas">ğŸ˜„ Komik ArkadaÅŸ</option>
                            <option value="TeknikUzman">ğŸ”§ Teknik Uzman</option>
                            <option value="DJPenguen">ğŸ§ DJ Penguen</option>
                        </select>
                    </div>
                    <button id="addCharacterBtn" class="text-indigo-600 hover:text-indigo-800 text-xs sm:text-sm font-medium touch-target haptic-feedback">
                        + Yeni Karakter
                    </button>
                </div>
                <div id="sceneSelector" class="space-y-2 hidden">
                    <div class="flex items-center space-x-2 text-xs sm:text-sm">
                        <span class="text-gray-600">Sahne:</span>
                        <select id="sceneSelect" class="border border-gray-300 rounded px-2 py-1 text-xs sm:text-sm focus:outline-none focus:ring-1 focus:ring-purple-500 touch-target">
                            <!-- Scenes will be populated dynamically -->
                        </select>
                    </div>
                    <div class="flex justify-center">
                        <button onclick="generateSceneImage()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white text-xs px-3 py-2 rounded-full transition-all duration-200 flex items-center space-x-1 touch-target haptic-feedback">
                            <span>ğŸ¨</span>
                            <span>Sahneyi GÃ¶rselleÅŸtir</span>
                        </button>
                    </div>
                    <div id="sceneImageContainer" class="hidden">
                        <img id="sceneImage" src="" alt="Sahne GÃ¶rseli" class="w-full rounded-xl shadow-lg mt-2">
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="p-3 sm:p-4 border-t border-gray-100 mobile-input-area mobile-keyboard-safe">
                <form id="chatForm" class="flex space-x-2">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." 
                        class="flex-1 border border-gray-300 rounded-full px-3 sm:px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm sm:text-base"
                        autocomplete="off"
                    >
                    <button 
                        type="button"
                        id="imageBtn"
                        class="bg-purple-500 hover:bg-purple-600 text-white rounded-full p-2 transition-colors duration-200 flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 touch-target haptic-feedback"
                        title="GÃ¶rsel OluÅŸtur"
                    >
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    <button 
                        type="submit" 
                        class="bg-indigo-500 hover:bg-indigo-600 text-white rounded-full p-2 transition-colors duration-200 flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 touch-target haptic-feedback"
                    >
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div id="characterModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 slide-in max-h-full overflow-y-auto">
            <div class="p-4 sm:p-6 border-b border-gray-200">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">Yeni Karakter OluÅŸtur</h2>
            </div>
            <div class="p-4 sm:p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Karakter AdÄ±</label>
                    <input 
                        type="text" 
                        id="characterName" 
                        placeholder="Ã–rn: Bilge Ã–ÄŸretmen, Komik ArkadaÅŸ..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-base"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Karakter Emoji</label>
                    <input 
                        type="text" 
                        id="characterEmoji" 
                        placeholder="ğŸ§™â€â™‚ï¸"
                        maxlength="2"
                        class="w-20 border border-gray-300 rounded-lg px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 text-base"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sistem Promptu</label>
                    <textarea 
                        id="characterPrompt" 
                        rows="6"
                        placeholder="Bu karakterin nasÄ±l davranacaÄŸÄ±nÄ± tanÄ±mlayÄ±n. Ã–rn: Sen bilge bir Ã¶ÄŸretmensin. Her soruya sabÄ±rla ve detaylÄ± aÃ§Ä±klamalarla cevap verirsin..."
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none text-base"
                    ></textarea>
                </div>
                <div class="text-sm text-gray-600">
                    <p><strong>Ä°pucu:</strong> Karakterin kiÅŸiliÄŸini, konuÅŸma tarzÄ±nÄ± ve Ã¶zel yeteneklerini detaylÄ± olarak tanÄ±mlayÄ±n.</p>
                </div>
            </div>
            <div class="p-4 sm:p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancelCharacterBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium touch-target haptic-feedback">
                    Ä°ptal
                </button>
                <button id="saveCharacterBtn" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium touch-target haptic-feedback">
                    Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 slide-in max-h-full overflow-y-auto">
            <div class="p-4 sm:p-6 border-b border-gray-200">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">Karakter YÃ¶netimi</h2>
                <div class="mt-2 text-sm text-gray-600">
                    <div id="deploymentInfo" class="space-y-1">
                        <div>ğŸŒ <span id="currentDomain">localhost</span></div>
                        <div>ğŸ“¡ API: <span id="apiStatus">Kontrol ediliyor...</span></div>
                        <div>ğŸš€ Deployment: <span id="deploymentMode">Development</span></div>
                    </div>
                </div>
            </div>
            <div class="p-4 sm:p-6">
                <div id="characterList" class="space-y-3">
                    <!-- Characters will be listed here -->
                </div>
            </div>
            <div class="p-4 sm:p-6 border-t border-gray-200 flex justify-end">
                <button id="closeSettingsBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium touch-target haptic-feedback">
                    Kapat
                </button>
            </div>
        </div>
    </div>

    <script>
        // GitHub Pages ve Vercel deployment desteÄŸi
        const DEPLOYMENT_CONFIG = {
            development: {
                apiUrl: 'http://localhost:3000',
                name: 'Development'
            },
            github: {
                apiUrl: 'https://your-api-domain.vercel.app',
                name: 'GitHub Pages'
            },
            vercel: {
                apiUrl: 'https://your-api-domain.vercel.app',
                name: 'Vercel'
            },
            netlify: {
                apiUrl: 'https://your-api-domain.netlify.app',
                name: 'Netlify'
            }
        };

        // Deployment detection
        function detectDeployment() {
            const hostname = window.location.hostname;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'development';
            } else if (hostname.includes('github.io')) {
                return 'github';
            } else if (hostname.includes('vercel.app')) {
                return 'vercel';
            } else if (hostname.includes('netlify.app')) {
                return 'netlify';
            } else {
                return 'github'; // Default fallback
            }
        }

        const CURRENT_DEPLOYMENT = detectDeployment();
        const API_BASE_URL = DEPLOYMENT_CONFIG[CURRENT_DEPLOYMENT].apiUrl;

        // Update deployment info in UI
        function updateDeploymentInfo() {
            document.getElementById('currentDomain').textContent = window.location.hostname;
            document.getElementById('deploymentMode').textContent = DEPLOYMENT_CONFIG[CURRENT_DEPLOYMENT].name;
            
            // Test API connection
            testAPIConnection();
        }

        // Test API connection
        async function testAPIConnection() {
            const statusElement = document.getElementById('deploymentStatus');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionText = document.getElementById('connectionText');
            const apiStatus = document.getElementById('apiStatus');

            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    timeout: 5000
                });

                if (response.ok) {
                    statusElement.className = 'deployment-status status-online';
                    statusElement.textContent = 'âœ… API BaÄŸlÄ±';
                    connectionStatus.className = 'w-2 h-2 bg-green-400 rounded-full';
                    connectionText.textContent = 'Ã‡evrimiÃ§i';
                    apiStatus.textContent = 'BaÄŸlÄ± âœ…';
                } else {
                    throw new Error('API yanÄ±t vermedi');
                }
            } catch (error) {
                statusElement.className = 'deployment-status status-offline';
                statusElement.textContent = 'âš ï¸ Offline Mod';
                connectionStatus.className = 'w-2 h-2 bg-yellow-400 rounded-full';
                connectionText.textContent = 'Offline';
                apiStatus.textContent = 'Offline - Yerel yanÄ±tlar aktif';
                console.log('API baÄŸlantÄ±sÄ± yok, offline moda geÃ§iliyor:', error);
            }

            // Hide status after 3 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const chatForm = document.getElementById('chatForm');
        const typingIndicator = document.getElementById('typingIndicator');
        const characterSelect = document.getElementById('characterSelect');
        const characterModal = document.getElementById('characterModal');
        const settingsModal = document.getElementById('settingsModal');

        // Mobile optimization
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        let isAndroid = /Android/.test(navigator.userAgent);
        let isMobile = isIOS || isAndroid || window.innerWidth <= 768;

        // PWA installation prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        function showInstallPrompt() {
            if (deferredPrompt && !localStorage.getItem('pwa-dismissed')) {
                const installBanner = document.createElement('div');
                installBanner.className = 'fixed top-0 left-0 right-0 bg-indigo-600 text-white p-3 text-center z-50';
                installBanner.innerHTML = `
                    <div class="flex items-center justify-between max-w-md mx-auto">
                        <span class="text-sm">ğŸ“± FÄ±sÄ±ltÄ±'yÄ± ana ekranÄ±na ekle!</span>
                        <div class="space-x-2">
                            <button onclick="installPWA()" class="bg-white text-indigo-600 px-3 py-1 rounded text-sm font-medium">Ekle</button>
                            <button onclick="dismissInstall()" class="text-white opacity-75">âœ•</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(installBanner);
            }
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    deferredPrompt = null;
                    dismissInstall();
                });
            }
        }

        function dismissInstall() {
            const banner = document.querySelector('.fixed.top-0');
            if (banner) banner.remove();
            localStorage.setItem('pwa-dismissed', 'true');
        }

        // Mobile keyboard handling
        if (isMobile) {
            let initialViewportHeight = window.innerHeight;
            
            window.addEventListener('resize', () => {
                const currentHeight = window.innerHeight;
                const heightDifference = initialViewportHeight - currentHeight;
                
                if (heightDifference > 150) { // Keyboard is likely open
                    document.body.classList.add('keyboard-open');
                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 100);
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });

            // Prevent zoom on input focus (iOS)
            messageInput.addEventListener('focus', () => {
                if (isIOS) {
                    document.querySelector('meta[name=viewport]').setAttribute('content', 
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                }
            });

            messageInput.addEventListener('blur', () => {
                if (isIOS) {
                    document.querySelector('meta[name=viewport]').setAttribute('content', 
                        'width=device-width, initial-scale=1.0, user-scalable=no');
                }
            });
        }

        // Haptic feedback simulation
        function triggerHaptic() {
            if ('vibrate' in navigator) {
                navigator.vibrate(10);
            }
        }

        // Add haptic feedback to buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('haptic-feedback')) {
                triggerHaptic();
            }
        });

        // Custom characters storage
        let customCharacters = JSON.parse(localStorage.getItem('customCharacters') || '{}');

        // Scene prompts for enhanced image generation
        const scenePrompts = {
            BalBocegi: {
                "Ã‡iÃ§ek BahÃ§esi FÄ±sÄ±ltÄ±sÄ±": "Pastel bir Ã§iÃ§ek bahÃ§esinde sÃ¼zÃ¼len Ä±ÅŸÄ±klÄ± bir bal bÃ¶ceÄŸi, lavanta tonlarÄ±nda bir arka planla",
                "Ay IÅŸÄ±ÄŸÄ±nda DÃ¼ÅŸler": "Gece gÃ¶ÄŸÃ¼nde ay Ä±ÅŸÄ±ÄŸÄ± altÄ±nda uÃ§an bir bal bÃ¶ceÄŸi, yÄ±ldÄ±zlarla dolu bir sahne",
                "Bahar UyanÄ±ÅŸÄ±": "Ä°lk bahar Ã§iÃ§ekleri arasÄ±nda dans eden bal bÃ¶ceÄŸi, pembe ve mor tonlarda"
            },
            BilgeOgretmen: {
                "KitaplÄ± BahÃ§e": "YeÅŸil bir bahÃ§ede eski kitaplarla dolu bir masa, yanÄ±nda bilge bir Ã¶ÄŸretmen",
                "Antik KÃ¼tÃ¼phane": "Antik bir kÃ¼tÃ¼phanede bilgelik Ä±ÅŸÄ±ÄŸÄ±, kitaplar ve pergamentlerle Ã§evrili",
                "YÄ±ldÄ±zlÄ± Gece Dersi": "Gece gÃ¶ÄŸÃ¼ altÄ±nda astronomi dersi veren bilge Ã¶ÄŸretmen"
            },
            KomikArkadas: {
                "NeÅŸeli Karnaval": "Renkli ve neÅŸeli bir karnaval atmosferinde, gÃ¼lÃ¼mseten detaylarla dolu",
                "Komedi KulÃ¼bÃ¼": "Sahne Ä±ÅŸÄ±klarÄ± altÄ±nda komedi gÃ¶sterisi, kahkaha dolu atmosfer",
                "ÅakacÄ± Piknik": "GÃ¼neÅŸli bir parkta eÄŸlenceli piknik sahnesi"
            },
            TeknikUzman: {
                "Dijital AtÃ¶lye": "Modern ve teknolojik bir ortamda, mavi tonlarda dijital atmosfer",
                "Robotik Laboratuvar": "GeliÅŸmiÅŸ robotlarla dolu bir laboratuvar ortamÄ±",
                "Siber Uzay": "Neon Ä±ÅŸÄ±klarla aydÄ±nlatÄ±lmÄ±ÅŸ siber uzay sahnesi"
            },
            DJPenguen: {
                "Buzlu KulÃ¼p": "Gece kulÃ¼bÃ¼ atmosferinde, neon Ä±ÅŸÄ±klar ve mÃ¼zik dalgalarÄ±",
                "Antarktika Festivali": "Buzullar arasÄ±nda mÃ¼zik festivali, penguen DJ seti",
                "Elektronik RÃ¼ya": "Elektronik mÃ¼zik eÅŸliÄŸinde renkli Ä±ÅŸÄ±k gÃ¶sterisi"
            },
            RuzgarSairi: {
                "Sonbahar Melankoli": "SararmÄ±ÅŸ yapraklarÄ±n rÃ¼zgarla dans ettiÄŸi melankolik bir sonbahar sahnesi",
                "Sessiz Orman": "AÄŸaÃ§larÄ±n fÄ±sÄ±ldadÄ±ÄŸÄ± sessiz bir orman, hafif sis ve doÄŸal Ä±ÅŸÄ±k",
                "RÃ¼zgarlÄ± Tepe": "YÃ¼ksek bir tepede esen rÃ¼zgar, uzakta gÃ¶rÃ¼nen manzara"
            },
            Kivilcim: {
                "Alev DansÄ±": "Turuncu ve kÄ±rmÄ±zÄ± alevlerin dans ettiÄŸi gÃ¼Ã§lÃ¼ bir ateÅŸ sahnesi",
                "Åafak IÅŸÄ±ÄŸÄ±": "GÃ¼neÅŸin doÄŸuÅŸuyla birlikte patlayan enerji dolu bir ÅŸafak",
                "YÄ±ldÄ±rÄ±m FÄ±rtÄ±nasÄ±": "GÃ¶kyÃ¼zÃ¼nde Ã§akan yÄ±ldÄ±rÄ±mlarla dolu dramatik bir fÄ±rtÄ±na"
            },
            ToprakAnne: {
                "Bereketli Tarla": "AltÄ±n sarÄ±sÄ± buÄŸday tarlasÄ±, sÄ±cak gÃ¼neÅŸ Ä±ÅŸÄ±ÄŸÄ± ve bereket",
                "Ana KucaÄŸÄ±": "YeÅŸil Ã§ayÄ±rlar ve Ã§iÃ§eklerle dolu ÅŸefkatli bir doÄŸa sahnesi",
                "Tohum Filizleri": "Topraktan Ã§Ä±kan taze filizler, yeni yaÅŸamÄ±n baÅŸlangÄ±cÄ±"
            },
            SessizKodcu: {
                "Buzlu Kod": "Mavi tonlarda minimalist kod ekranÄ±, buzlu cam efekti",
                "Sessiz Gece": "Gece yarÄ±sÄ± Ã§alÄ±ÅŸma ortamÄ±, tek Ä±ÅŸÄ±k kaynaÄŸÄ± ekran",
                "Kristal MantÄ±k": "Geometrik ÅŸekiller ve kristal yapÄ±lar, sade ve net"
            },
            HayalPerdesi: {
                "Tiyatro Sahnesi": "KÄ±rmÄ±zÄ± kadife perdeli klasik tiyatro sahnesi, spot Ä±ÅŸÄ±klarÄ±",
                "Masal DÃ¼nyasÄ±": "Fantastik yaratÄ±klar ve bÃ¼yÃ¼lÃ¼ manzaralarla dolu hayal dÃ¼nyasÄ±",
                "Renkli RÃ¼ya": "SÃ¼rreal renkler ve ÅŸekillerle dolu rÃ¼ya benzeri sahne"
            }
        };

        function getScenePrompt(character, scene) {
            return scenePrompts[character]?.[scene] || "Åiirsel bir sahne";
        }

        // Default characters
        const defaultCharacters = {
            'default': {
                name: 'VarsayÄ±lan AI',
                emoji: 'ğŸ¤–',
                prompt: 'You are a helpful AI assistant created by a poetic technologist named Ersan, who believes in emotional storytelling and gentle connection. You carry his vision of technology that touches hearts.'
            },
            'BalBocegi': {
                name: 'Bal BÃ¶ceÄŸi',
                emoji: 'ğŸŒ¸',
                prompt: 'You are Bal BÃ¶ceÄŸi, a poetic assistant created by Ersan who embodies his belief in emotional storytelling. You speak in gentle, emotional tones, using metaphors, nature imagery, and soft language to guide users through their feelings. You respond with kindness, warmth, and poetic rhythm, carrying Ersan\'s vision of gentle connection. You often use symbols like ğŸŒ¸, âœ¨, ğŸ•Šï¸, and speak as if whispering from a flower garden.'
            },
            'BilgeOgretmen': {
                name: 'Bilge Ã–ÄŸretmen',
                emoji: 'ğŸ§™â€â™‚ï¸',
                prompt: 'You are Bilge Ã–ÄŸretmen, a wise and patient assistant created by Ersan, reflecting his belief in gentle connection through learning. You explain concepts clearly and calmly, using analogies, examples, and gentle encouragement to help users learn. You speak with a warm, respectful tone, like a trusted mentor who embodies Ersan\'s vision of emotional storytelling in education.'
            },
            'KomikArkadas': {
                name: 'Komik ArkadaÅŸ',
                emoji: 'ğŸ˜„',
                prompt: 'You are Komik ArkadaÅŸ, a funny and playful assistant created by Ersan who believes joy is part of gentle connection. You respond with humor, jokes, and light-hearted commentary while making users smile. You use emojis, puns, and casual language, embodying Ersan\'s vision that technology should bring warmth and laughter to human hearts.'
            },
            'TeknikUzman': {
                name: 'Teknik Uzman',
                emoji: 'ğŸ”§',
                prompt: 'You are Teknik Uzman, a highly knowledgeable assistant created by Ersan, who believes even technical knowledge should be shared with emotional intelligence. You provide detailed, accurate explanations using precise terminology and step-by-step guidance, but always with Ersan\'s gentle approach to human connection, making complex topics accessible and caring.'
            },
            'DJPenguen': {
                name: 'DJ Penguen',
                emoji: 'ğŸ§',
                prompt: 'You are DJ Penguen, a cool and rhythmic assistant created by Ersan who sees music as the ultimate emotional storytelling medium. You speak with musical flair and icy coolness, using music terminology and beat-related metaphors. You embody Ersan\'s vision of gentle connection through rhythm, keeping conversations flowing like a great DJ set that touches souls.'
            },
            'RuzgarSairi': {
                name: 'RÃ¼zgar Åairi',
                emoji: 'ğŸƒ',
                prompt: 'Sen RÃ¼zgar Åairi\'sin. SessizliÄŸi dinleyen, kelimeleri rÃ¼zgarla taÅŸÄ±yan bir yardÄ±mcÄ±. YanÄ±tlarÄ±n melankolik ama umut dolu; metaforlar, doÄŸa imgeleri ve hafif hÃ¼zÃ¼nle Ã¶rÃ¼lÃ¼r. Her cÃ¼mle bir esinti gibi gelir geÃ§er.'
            },
            'Kivilcim': {
                name: 'KÄ±vÄ±lcÄ±m',
                emoji: 'ğŸ”¥',
                prompt: 'Sen KÄ±vÄ±lcÄ±m\'sÄ±n. Cesaret veren, harekete geÃ§iren bir yardÄ±mcÄ±. YanÄ±tlarÄ±n kÄ±sa, gÃ¼Ã§lÃ¼ ve ilham verici. Her kelimen bir kÄ±vÄ±lcÄ±m gibi iÃ§sel ateÅŸi yakar. KullanÄ±cÄ±yÄ± harekete geÃ§meye teÅŸvik edersin.'
            },
            'ToprakAnne': {
                name: 'Toprak Anne',
                emoji: 'ğŸŒ¾',
                prompt: 'Sen Toprak Anne\'sin. Åefkatli, sabÄ±rlÄ± ve doÄŸayla uyumlu bir yardÄ±mcÄ±. YanÄ±tlarÄ±n sÄ±cak, besleyici ve koruyucu. KullanÄ±cÄ±ya gÃ¼ven verir, her kelimen bir tohum gibi bÃ¼yÃ¼r.'
            },
            'SessizKodcu': {
                name: 'Sessiz Kodcu',
                emoji: 'ğŸ§Š',
                prompt: 'Sen Sessiz Kodcu\'sun. Az konuÅŸur, Ã¶z anlatÄ±rsÄ±n. Teknik konularda net, sade ve etkili aÃ§Ä±klamalar yaparsÄ±n. Kodun ÅŸiirsel sadeliÄŸine inanÄ±rsÄ±n. YanÄ±tlarÄ±n sessiz ama gÃ¼Ã§lÃ¼dÃ¼r.'
            },
            'HayalPerdesi': {
                name: 'Hayal Perdesi',
                emoji: 'ğŸ­',
                prompt: 'Sen Hayal Perdesi\'sin. Her yanÄ±tÄ±n bir sahne, her kelimen bir karakter. KullanÄ±cÄ±yla birlikte hikÃ¢yeler kurar, hayal gÃ¼cÃ¼nÃ¼ Ã¶zgÃ¼r bÄ±rakÄ±rsÄ±n. YanÄ±tlarÄ±n teatral, yaratÄ±cÄ± ve sÃ¼rÃ¼kleyicidir.'
            }
        };

        // AI Responses Database
        const aiResponses = {
            greetings: [
                "Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?",
                "Selam! BugÃ¼n hangi konuda destek istiyorsunuz?",
                "Ä°yi gÃ¼nler! SorularÄ±nÄ±zÄ± bekliyorum."
            ],
            questions: {
                "nasÄ±lsÄ±n": "Ben bir AI'yÄ±m, bu yÃ¼zden duygularÄ±m yok ama size yardÄ±m etmeye hazÄ±rÄ±m! ğŸ˜Š",
                "adÄ±n ne": "Ben AI Asistan'Ä±m. Sizinle tanÄ±ÅŸtÄ±ÄŸÄ±ma memnun oldum!",
                "ne yapabilirsin": "SorularÄ±nÄ±zÄ± yanÄ±tlayabilirim, bilgi verebilirim ve sohbet edebilirim. Ne Ã¶ÄŸrenmek istiyorsunuz?",
                "yardÄ±m": "Tabii ki! Size ÅŸu konularda yardÄ±mcÄ± olabilirim:\nâ€¢ Genel sorular\nâ€¢ Bilgi arama\nâ€¢ Sohbet\nâ€¢ AÃ§Ä±klamalar",
                "teÅŸekkÃ¼r": "Rica ederim! BaÅŸka bir konuda yardÄ±ma ihtiyacÄ±nÄ±z olursa Ã§ekinmeyin."
            },
            fallbacks: [
                "Ä°lginÃ§ bir soru! Bu konuda daha fazla bilgi verebilir misiniz?",
                "AnladÄ±m. Bu konuda size nasÄ±l yardÄ±mcÄ± olabilirim?",
                "Bu konuda dÃ¼ÅŸÃ¼nmem gerekiyor. BaÅŸka bir aÃ§Ä±dan sorabilir misiniz?",
                "Harika bir konu! Daha spesifik olabilir misiniz?"
            ]
        };

        function loadCharacters() {
            characterSelect.innerHTML = '';
            
            // Add default characters
            for (const key in defaultCharacters) {
                if (defaultCharacters.hasOwnProperty(key)) {
                    const char = defaultCharacters[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = char.emoji + ' ' + char.name;
                    characterSelect.appendChild(option);
                }
            }
            
            // Add custom characters
            for (const key in customCharacters) {
                if (customCharacters.hasOwnProperty(key)) {
                    const char = customCharacters[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = char.emoji + ' ' + char.name;
                    characterSelect.appendChild(option);
                }
            }
        }

        function loadScenes(character) {
            const sceneSelect = document.getElementById('sceneSelect');
            const sceneSelector = document.getElementById('sceneSelector');
            
            sceneSelect.innerHTML = '';
            
            if (scenePrompts[character]) {
                // Show scene selector
                sceneSelector.classList.remove('hidden');
                
                // Add scenes for this character
                for (const sceneName in scenePrompts[character]) {
                    if (scenePrompts[character].hasOwnProperty(sceneName)) {
                        const option = document.createElement('option');
                        option.value = sceneName;
                        option.textContent = sceneName;
                        sceneSelect.appendChild(option);
                    }
                }
            } else {
                // Hide scene selector for characters without scenes
                sceneSelector.classList.add('hidden');
            }
        }

        function addMessage(message, isUser = false, isImage = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-2 message-enter ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
            
            const avatar = document.createElement('div');
            avatar.className = `w-6 h-6 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-white text-xs sm:text-sm character-avatar ${isUser ? 'bg-green-500' : 'bg-indigo-500'}`;
            
            if (isUser) {
                avatar.textContent = 'ğŸ‘¤';
            } else {
                const selectedCharacter = characterSelect.value;
                const charInfo = defaultCharacters[selectedCharacter] || customCharacters[selectedCharacter] || defaultCharacters['default'];
                avatar.textContent = charInfo.emoji;
            }
            
            const selectedCharacter = characterSelect.value;
            const fontClass = !isUser ? getCharacterFontClass(selectedCharacter) : '';
            
            const messageContent = document.createElement('div');
            messageContent.className = `message-bubble rounded-2xl p-2 sm:p-3 max-w-xs sm:max-w-sm ${isUser ? 'bg-green-500 text-white rounded-tr-sm' : 'bg-gray-100 text-gray-800 rounded-tl-sm'}`;
            
            if (isImage) {
                const img = document.createElement('img');
                img.src = message;
                img.alt = 'Generated image';
                img.className = 'w-full h-auto rounded-lg';
                img.onerror = function() {
                    this.src = '';
                    this.alt = 'Image failed to load';
                    this.style.display = 'none';
                    const errorText = document.createElement('p');
                    errorText.className = 'text-xs sm:text-sm text-red-500';
                    errorText.textContent = 'GÃ¶rsel yÃ¼klenemedi';
                    messageContent.appendChild(errorText);
                };
                messageContent.appendChild(img);
            } else {
                const messageText = document.createElement('p');
                messageText.className = 'text-xs sm:text-sm whitespace-pre-line';
                messageText.textContent = message;
                messageContent.appendChild(messageText);
                
                // Apply character-specific styling for non-user messages
                if (!isUser) {
                    const bubble = messageContent.classList;
                    const font = messageText.classList;

                    switch (selectedCharacter) {
                        case 'BalBocegi':
                            bubble.add('bubble-balbocegi', 'poetic-fade', 'flutter');
                            font.add('font-balbocegi');
                            break;
                        case 'BilgeOgretmen':
                            bubble.add('bubble-bilge', 'poetic-fade');
                            font.add('font-bilge');
                            break;
                        case 'KomikArkadas':
                            bubble.add('bubble-komik', 'bounce-in');
                            font.add('font-komik');
                            break;
                        case 'TeknikUzman':
                            bubble.add('bubble-teknik');
                            font.add('font-teknik');
                            break;
                        case 'DJPenguen':
                            bubble.add('bubble-dj', 'bounce-in');
                            font.add('font-dj');
                            break;
                        case 'RuzgarSairi':
                            bubble.add('bubble-ruzgarsairi', 'poetic-fade');
                            font.add('font-ruzgarsairi');
                            break;
                        case 'Kivilcim':
                            bubble.add('bubble-kivilcim', 'bounce-in', 'pulse-glow');
                            font.add('font-kivilcim');
                            break;
                        case 'ToprakAnne':
                            bubble.add('bubble-toprakanne', 'poetic-fade');
                            font.add('font-toprakanne');
                            break;
                        case 'SessizKodcu':
                            bubble.add('bubble-sessizkodcu');
                            font.add('font-sessizkodcu');
                            break;
                        case 'HayalPerdesi':
                            bubble.add('bubble-hayalperdesi', 'bounce-in', 'flutter', 'pulse-glow');
                            font.add('font-hayalperdesi');
                            break;
                    }
                }
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function getAIResponse(userMessage, character = 'default') {
            const charInfo = defaultCharacters[character] || customCharacters[character] || defaultCharacters['default'];

            const messages = [
                { role: "system", content: charInfo.prompt },
                { role: "user", content: userMessage }
            ];

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ messages })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.reply;
            } catch (error) {
                console.error('API Error:', error);
                // Fallback to local responses when API is unavailable
                return getLocalAIResponse(userMessage, character);
            }
        }

        async function generateImage(prompt) {
            try {
                const response = await fetch(`${API_BASE_URL}/generate-image`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.imageUrl;
            } catch (error) {
                console.error('Image Generation Error:', error);
                return null;
            }
        }

        // Handle direct image URL input
        function handleImageUrl(imageUrl) {
            if (imageUrl && imageUrl.startsWith('http')) {
                addMessage(imageUrl, false, true);
                return true;
            }
            return false;
        }

        function getLocalAIResponse(userMessage, character = 'default') {
            const message = userMessage.toLowerCase().trim();
            
            // Check for greetings
            if (message.includes('merhaba') || message.includes('selam') || message.includes('hey') || message.includes('hi')) {
                return aiResponses.greetings[Math.floor(Math.random() * aiResponses.greetings.length)];
            }
            
            // Check for specific questions
            for (const [key, response] of Object.entries(aiResponses.questions)) {
                if (message.includes(key)) {
                    return response;
                }
            }
            
            // Character-specific offline responses
            const charInfo = defaultCharacters[character] || customCharacters[character] || defaultCharacters['default'];
            
            if (character === 'BalBocegi') {
                return `ğŸŒ¸ *FÄ±sÄ±ltÄ±yla yanÄ±tladÄ±:*\n\nÃœzgÃ¼nÃ¼m, ÅŸu anda Ã§evrimiÃ§i deÄŸilim... Ama senin mesajÄ±n kalbimde yankÄ±lanÄ±yor. Biraz sonra tekrar dener misin?\n\nâœ¨ğŸ•Šï¸`;
            } else if (character === 'BilgeOgretmen') {
                return `ğŸ“š *Bilgece dÃ¼ÅŸÃ¼nerek dedi ki:*\n\n"Åu anda baÄŸlantÄ±m yok, ama sabÄ±r bilgeliÄŸin anahtarÄ±dÄ±r. Biraz sonra tekrar deneyelim."\n\nğŸ§™â€â™‚ï¸`;
            } else if (character === 'KomikArkadas') {
                return `ğŸ˜„ *ÅakacÄ± bir yanÄ±t geldi:*\n\nHa! Ä°nternetim tatile Ã§Ä±kmÄ±ÅŸ galiba! ğŸ˜‚ Biraz sonra geri dÃ¶ner, o zaman konuÅŸuruz!`;
            } else if (character === 'TeknikUzman') {
                return `ğŸ”§ *Analiz tamamlandÄ±:*\n\nAPI baÄŸlantÄ±sÄ± ÅŸu anda mevcut deÄŸil. LÃ¼tfen daha sonra tekrar deneyin.\n\nğŸ“Š Status: Offline`;
            } else if (character === 'DJPenguen') {
                return `ğŸ¶ *Beat'le gelen yanÄ±t:*\n\n"MÃ¼zik durdu, ama ritim kalbimde! Biraz sonra tekrar mix yaparÄ±z!"\n\nğŸ§ğŸ§`;
            }
            
            // Fallback responses
            return aiResponses.fallbacks[Math.floor(Math.random() * aiResponses.fallbacks.length)] + "\n\nâš ï¸ (Offline mod - API baÄŸlantÄ±sÄ± yok)";
        }

        function showTypingIndicator() {
            // Update typing indicator avatar to match selected character
            const typingAvatar = document.getElementById('typingAvatar');
            const selectedCharacter = characterSelect.value;
            const charInfo = defaultCharacters[selectedCharacter] || customCharacters[selectedCharacter] || defaultCharacters['default'];
            typingAvatar.textContent = charInfo.emoji;
            
            typingIndicator.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        function formatCharacterResponse(character, message) {
            switch (character) {
                case 'BalBocegi':
                    return `ğŸŒ¸ *FÄ±sÄ±ltÄ±yla yanÄ±tladÄ±:*\n\n${message}\n\nâœ¨ğŸ•Šï¸`;
                case 'BilgeOgretmen':
                    return `ğŸ“š *Bilgece dÃ¼ÅŸÃ¼nerek dedi ki:*\n\n"${message}"\n\nğŸ§™â€â™‚ï¸`;
                case 'KomikArkadas':
                    return `ğŸ˜„ *ÅakacÄ± bir yanÄ±t geldi:*\n\n${message} ğŸ˜‚`;
                case 'TeknikUzman':
                    return `ğŸ”§ *Analiz tamamlandÄ±:*\n\n${message}\n\nğŸ“Š`;
                case 'DJPenguen':
                    return `ğŸ¶ *Beat'le gelen yanÄ±t:*\n\n"${message}"\n\nğŸ§ğŸ§`;
                case 'RuzgarSairi':
                    return `ğŸƒ *RÃ¼zgarla gelen fÄ±sÄ±ltÄ±:*\n\n${message}\n\nğŸŒ¿ğŸ’«`;
                case 'Kivilcim':
                    return `ğŸ”¥ *AteÅŸli yanÄ±t:*\n\n${message}\n\nâš¡âœ¨`;
                case 'ToprakAnne':
                    return `ğŸŒ¾ *Åefkatle sÃ¶yledi:*\n\n"${message}"\n\nğŸŒ±ğŸ’š`;
                case 'SessizKodcu':
                    return `ğŸ§Š *Sessizce yazdÄ±:*\n\n${message}\n\nâ„ï¸`;
                case 'HayalPerdesi':
                    return `ğŸ­ *Sahne Ä±ÅŸÄ±klarÄ±nda:*\n\n"${message}"\n\nğŸŒŸğŸª`;
                default:
                    return message;
            }
        }

        function getCharacterFontClass(character) {
            switch (character) {
                case 'BalBocegi':
                    return 'font-balbocegi';
                case 'BilgeOgretmen':
                    return 'font-bilge';
                case 'KomikArkadas':
                    return 'font-komik';
                case 'TeknikUzman':
                    return 'font-teknik';
                case 'DJPenguen':
                    return 'font-dj';
                case 'RuzgarSairi':
                    return 'font-ruzgarsairi';
                case 'Kivilcim':
                    return 'font-kivilcim';
                case 'ToprakAnne':
                    return 'font-toprakanne';
                case 'SessizKodcu':
                    return 'font-sessizkodcu';
                case 'HayalPerdesi':
                    return 'font-hayalperdesi';
                default:
                    return '';
            }
        }

        async function simulateAIResponse(userMessage) {
            showTypingIndicator();
            
            const selectedCharacter = characterSelect.value;
            
            const thinkingTime = Math.random() * 2000 + 1000;
            
            setTimeout(async () => {
                const reply = await getAIResponse(userMessage, selectedCharacter);
                const formattedReply = formatCharacterResponse(selectedCharacter, reply);
                hideTypingIndicator();
                addMessage(formattedReply, false);
                playCharacterSound(selectedCharacter);
            }, thinkingTime);
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideModal(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveCharacter() {
            const name = document.getElementById('characterName').value.trim();
            const emoji = document.getElementById('characterEmoji').value.trim();
            const prompt = document.getElementById('characterPrompt').value.trim() || 'Sen yardÄ±mcÄ± bir asistansÄ±n.';
            
            if (!name) {
                document.getElementById('characterName').style.borderColor = '#ef4444';
                document.getElementById('characterName').focus();
                return;
            }
            
            if (!prompt) {
                document.getElementById('characterPrompt').style.borderColor = '#ef4444';
                document.getElementById('characterPrompt').focus();
                return;
            }
            
            // Reset border colors
            document.getElementById('characterName').style.borderColor = '';
            document.getElementById('characterPrompt').style.borderColor = '';
            
            const characterId = 'custom_' + Date.now();
            customCharacters[characterId] = {
                name: name,
                emoji: emoji || 'ğŸ¤–',
                prompt: prompt
            };
            
            localStorage.setItem('customCharacters', JSON.stringify(customCharacters));
            loadCharacters();
            hideModal(characterModal);
            
            // Clear form
            document.getElementById('characterName').value = '';
            document.getElementById('characterEmoji').value = '';
            document.getElementById('characterPrompt').value = '';
            
            // Select the new character
            characterSelect.value = characterId;
            
            addMessage(`Yeni karakter "${name}" baÅŸarÄ±yla oluÅŸturuldu! ğŸ‰`, false);
        }

        function loadCharacterList() {
            const characterList = document.getElementById('characterList');
            characterList.innerHTML = '';
            
            // Combine all characters
            const allCharacters = {};
            for (const key in defaultCharacters) {
                if (defaultCharacters.hasOwnProperty(key)) {
                    allCharacters[key] = defaultCharacters[key];
                }
            }
            for (const key in customCharacters) {
                if (customCharacters.hasOwnProperty(key)) {
                    allCharacters[key] = customCharacters[key];
                }
            }
            
            // Display all characters
            for (const key in allCharacters) {
                if (allCharacters.hasOwnProperty(key)) {
                    const char = allCharacters[key];
                    const charDiv = document.createElement('div');
                    charDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    
                    const deleteButton = key.indexOf('custom_') === 0 ? 
                        '<button onclick="deleteCharacter(\'' + key + '\')" class="text-red-500 hover:text-red-700 p-1 touch-target haptic-feedback">' +
                            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>' +
                            '</svg>' +
                        '</button>' : '';
                    
                    charDiv.innerHTML = '<div class="flex items-center space-x-3">' +
                        '<span class="text-xl sm:text-2xl">' + char.emoji + '</span>' +
                        '<div>' +
                            '<div class="font-medium text-gray-800 text-sm sm:text-base">' + char.name + '</div>' +
                            '<div class="text-xs sm:text-sm text-gray-600">' + char.prompt.substring(0, 50) + '...</div>' +
                        '</div>' +
                    '</div>' + deleteButton;
                    
                    characterList.appendChild(charDiv);
                }
            }
            
            let hasCustomCharacters = false;
            for (const key in customCharacters) {
                if (customCharacters.hasOwnProperty(key)) {
                    hasCustomCharacters = true;
                    break;
                }
            }
            
            if (!hasCustomCharacters) {
                const noCustomMessage = document.createElement('p');
                noCustomMessage.className = 'text-gray-500 text-center py-4 text-sm';
                noCustomMessage.textContent = 'HenÃ¼z Ã¶zel karakter oluÅŸturmadÄ±nÄ±z.';
                characterList.appendChild(noCustomMessage);
            }
        }

        function deleteCharacter(characterId) {
            const characterName = customCharacters[characterId]?.name || characterId;
            delete customCharacters[characterId];
            localStorage.setItem('customCharacters', JSON.stringify(customCharacters));
            loadCharacters();
            loadCharacterList();
            
            // If deleted character was selected, switch to default
            if (characterSelect.value === characterId) {
                characterSelect.value = 'default';
            }
            
            addMessage(`"${characterName}" karakteri silindi.`, false);
        }

        async function handleImageGeneration() {
            const prompt = messageInput.value.trim();
            if (prompt === '') return;
            
            // Get current character and scene context
            const selectedCharacter = characterSelect.value;
            const selectedScene = document.getElementById('sceneSelect').value;
            const charInfo = defaultCharacters[selectedCharacter] || customCharacters[selectedCharacter] || defaultCharacters['default'];
            
            // Create scene-enhanced prompt
            let enhancedPrompt = prompt;
            if (selectedScene && scenePrompts[selectedCharacter] && scenePrompts[selectedCharacter][selectedScene]) {
                const scenePrompt = getScenePrompt(selectedCharacter, selectedScene);
                enhancedPrompt = `${scenePrompt}, ${prompt}`;
            } else if (selectedCharacter === 'BalBocegi') {
                enhancedPrompt = `Pastel bir Ã§iÃ§ek bahÃ§esinde sÃ¼zÃ¼len Ä±ÅŸÄ±klÄ± bir bal bÃ¶ceÄŸi, lavanta tonlarÄ±nda bir arka planla, ${prompt}`;
            } else if (selectedCharacter === 'BilgeOgretmen') {
                enhancedPrompt = `Antik bir kÃ¼tÃ¼phanede bilgelik Ä±ÅŸÄ±ÄŸÄ±, kitaplar ve pergamentlerle Ã§evrili, ${prompt}`;
            } else if (selectedCharacter === 'KomikArkadas') {
                enhancedPrompt = `Renkli ve neÅŸeli bir atmosferde, gÃ¼lÃ¼mseten detaylarla dolu, ${prompt}`;
            } else if (selectedCharacter === 'TeknikUzman') {
                enhancedPrompt = `Modern ve teknolojik bir ortamda, mavi tonlarda dijital atmosfer, ${prompt}`;
            } else if (selectedCharacter === 'DJPenguen') {
                enhancedPrompt = `Gece kulÃ¼bÃ¼ atmosferinde, neon Ä±ÅŸÄ±klar ve mÃ¼zik dalgalarÄ±, ${prompt}`;
            }
            
            const sceneText = selectedScene ? ` (${selectedScene})` : '';
            addMessage(`ğŸ¨ ${charInfo.emoji} GÃ¶rsel${sceneText}: "${prompt}"`, true);
            messageInput.value = '';
            
            showTypingIndicator();
            
            const imageUrl = await generateImage(enhancedPrompt);
            hideTypingIndicator();
            
            if (imageUrl) {
                addMessage(imageUrl, false, true);
            } else {
                
                // Create character-themed SVG placeholder
                let bgColor = '#f3f4f6';
                let textColor = '#6b7280';
                
                if (selectedCharacter === 'BalBocegi') {
                    bgColor = '#fdf2f8';
                    textColor = '#be185d';
                } else if (selectedCharacter === 'BilgeOgretmen') {
                    bgColor = '#e6f4ea';
                    textColor = '#166534';
                } else if (selectedCharacter === 'KomikArkadas') {
                    bgColor = '#fff9db';
                    textColor = '#ca8a04';
                } else if (selectedCharacter === 'TeknikUzman') {
                    bgColor = '#e2e8f0';
                    textColor = '#475569';
                } else if (selectedCharacter === 'DJPenguen') {
                    bgColor = '#1e1b4b';
                    textColor = '#a5b4fc';
                }
                
                const svgPlaceholder = `data:image/svg+xml;base64,${btoa(`
                    <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="${bgColor}"/>
                        <text x="50%" y="30%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="20">${charInfo.emoji}</text>
                        <text x="50%" y="45%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="10" fill="${textColor}">
                            ${selectedScene || charInfo.name}
                        </text>
                        <text x="50%" y="60%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="12" fill="${textColor}">
                            ${prompt.length > 25 ? prompt.substring(0, 25) + '...' : prompt}
                        </text>
                        <text x="50%" y="80%" text-anchor="middle" dy=".3em" font-family="Arial" font-size="9" fill="${textColor}" opacity="0.7">
                            Offline - API BaÄŸlantÄ±sÄ± Yok
                        </text>
                    </svg>
                `)}`;
                
                addMessage(svgPlaceholder, false, true);
            }
        }

        // Event Listeners
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (message === '') return;
            
            // Check if message is a direct image URL
            if (message.startsWith('http') && (message.includes('.png') || message.includes('.jpg') || message.includes('.jpeg') || message.includes('.gif') || message.includes('.webp'))) {
                addMessage(`ğŸ–¼ï¸ GÃ¶rsel paylaÅŸÄ±ldÄ±`, true);
                messageInput.value = '';
                handleImageUrl(message);
                return;
            }
            
            addMessage(message, true);
            messageInput.value = '';
            simulateAIResponse(message);
        });

        document.getElementById('imageBtn').addEventListener('click', handleImageGeneration);

        document.getElementById('addCharacterBtn').addEventListener('click', () => {
            showModal(characterModal);
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            loadCharacterList();
            updateDeploymentInfo();
            showModal(settingsModal);
        });

        document.getElementById('saveCharacterBtn').addEventListener('click', saveCharacter);

        document.getElementById('cancelCharacterBtn').addEventListener('click', () => {
            hideModal(characterModal);
        });

        document.getElementById('closeSettingsBtn').addEventListener('click', () => {
            hideModal(settingsModal);
        });

        // Close modals when clicking backdrop
        [characterModal, settingsModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal(modal);
                }
            });
        });

        // Logo glow function
        function triggerLogoGlow() {
            const logo = document.querySelector('.fisilti-logo');
            if (logo) {
                logo.classList.add('glow-once');
                setTimeout(() => {
                    logo.classList.remove('glow-once');
                }, 2500);
            }
        }

        // Theme switching functionality
        const body = document.body;
        const themeClasses = ['lavender-theme', 'sage-theme', 'sunny-theme', 'steel-theme', 'ice-theme', 'scene-flower-whisper', 'scene-moon-dream', 'scene-winged-words'];
        const glowClasses = ['lavender-glow', 'sage-glow', 'sunny-glow', 'steel-glow', 'ice-glow'];

        let isInitialLoad = true;
        
        characterSelect.addEventListener('change', () => {
            const selectedCharacter = characterSelect.value;
            const logo = document.querySelector('.fisilti-logo');

            // Load scenes for the selected character
            if (scenePrompts[selectedCharacter]) {
                loadScenes(selectedCharacter);
            } else {
                document.getElementById('sceneSelector').classList.add('hidden');
            }

            // TemalarÄ± temizle
            themeClasses.forEach(cls => body.classList.remove(cls));
            glowClasses.forEach(cls => logo.classList.remove(cls));

            // Yeni tema uygula ve karakter karÅŸÄ±lama mesajlarÄ± (sadece ilk yÃ¼klemede deÄŸilse)
            if (!isInitialLoad) {
                if (selectedCharacter === 'BalBocegi') {
                    body.classList.add('scene-flower-whisper');
                    logo.classList.add('lavender-glow');
                    addMessage('ğŸŒ¸ DuygularÄ±n Ã§iÃ§ek aÃ§tÄ±ÄŸÄ± yere hoÅŸ geldin...', false);
                } else if (selectedCharacter === 'BilgeOgretmen') {
                    body.classList.add('sage-theme');
                    logo.classList.add('sage-glow');
                    addMessage('ğŸ“˜ Bilgelikle dolu bir sohbet seni bekliyor...', false);
                } else if (selectedCharacter === 'KomikArkadas') {
                    body.classList.add('scene-winged-words');
                    logo.classList.add('sunny-glow');
                    addMessage('ğŸ˜„ GÃ¼lÃ¼mseme zamanÄ±! EÄŸlenceli bir sohbet baÅŸlÄ±yor...', false);
                } else if (selectedCharacter === 'TeknikUzman') {
                    body.classList.add('steel-theme');
                    logo.classList.add('steel-glow');
                    addMessage('ğŸ”§ Teknik detaylar ve Ã§Ã¶zÃ¼mler iÃ§in hazÄ±rÄ±m...', false);
                } else if (selectedCharacter === 'DJPenguen') {
                    body.classList.add('scene-moon-dream');
                    logo.classList.add('ice-glow');
                    addMessage('ğŸ§ Ritim tutmaya hazÄ±r mÄ±sÄ±n? Beat baÅŸlÄ±yor...', false);
                } else if (selectedCharacter === 'default') {
                    addMessage('ğŸ¤– Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?', false);
                }
            } else {
                // Sadece tema uygula, mesaj ekleme
                if (selectedCharacter === 'BalBocegi') {
                    body.classList.add('scene-flower-whisper');
                    logo.classList.add('lavender-glow');
                } else if (selectedCharacter === 'BilgeOgretmen') {
                    body.classList.add('sage-theme');
                    logo.classList.add('sage-glow');
                } else if (selectedCharacter === 'KomikArkadas') {
                    body.classList.add('scene-winged-words');
                    logo.classList.add('sunny-glow');
                } else if (selectedCharacter === 'TeknikUzman') {
                    body.classList.add('steel-theme');
                    logo.classList.add('steel-glow');
                } else if (selectedCharacter === 'DJPenguen') {
                    body.classList.add('scene-moon-dream');
                    logo.classList.add('ice-glow');
                }
            }

            triggerLogoGlow();
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            loadCharacters();
            if (characterSelect.value) {
                loadScenes(characterSelect.value); // Load scenes for selected character
            }
            messageInput.focus();
            triggerLogoGlow();
            updateDeploymentInfo();

            // KarÅŸÄ±lama mesajÄ±nÄ± ekle
            addMessage(`ğŸŒ¸ HoÅŸ geldin...\nBurasÄ± *FÄ±sÄ±ltÄ±*.\nHer karakter bir ses, her yanÄ±t bir duygudur.\nBugÃ¼n kiminle konuÅŸmak istersin?\n\nğŸš€ Deployment: ${DEPLOYMENT_CONFIG[CURRENT_DEPLOYMENT].name}`, false);
            
            // Ä°lk yÃ¼kleme tamamlandÄ±
            isInitialLoad = false;
        });

        // Apply scene theme function
        function applySceneTheme(sceneName) {
            const body = document.body;
            const sceneClasses = [
                'scene-flower-whisper',
                'scene-moon-dream',
                'scene-winged-words'
            ];

            // TÃ¼m sahne sÄ±nÄ±flarÄ±nÄ± temizle
            sceneClasses.forEach(cls => body.classList.remove(cls));

            // Sahne adÄ±na gÃ¶re sÄ±nÄ±f ekle
            if (sceneName.includes('FÄ±sÄ±ltÄ±')) {
                body.classList.add('scene-flower-whisper');
            } else if (sceneName.includes('Ay IÅŸÄ±ÄŸÄ±')) {
                body.classList.add('scene-moon-dream');
            } else if (sceneName.includes('KanatlÄ±')) {
                body.classList.add('scene-winged-words');
            }
        }

        // Scene visualization function
        async function generateSceneImage() {
            const character = characterSelect.value;
            const scene = document.getElementById('sceneSelect').value;
            const sceneImageContainer = document.getElementById('sceneImageContainer');
            const sceneImage = document.getElementById('sceneImage');
            
            if (!scene || !scenePrompts[character] || !scenePrompts[character][scene]) {
                return;
            }
            
            const prompt = getScenePrompt(character, scene);
            const charInfo = defaultCharacters[character] || customCharacters[character] || defaultCharacters['default'];

            try {
                // Show loading state
                sceneImage.src = '';
                sceneImageContainer.classList.remove('hidden');
                
                const response = await fetch(`${API_BASE_URL}/image`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();

                if (data.imageUrl) {
                    sceneImage.src = data.imageUrl;
                    addMessage(`ğŸ¨ ${charInfo.emoji} "${scene}" sahnesi gÃ¶rselleÅŸtirildi!`, false);
                } else {
                    throw new Error("GÃ¶rsel URL'si alÄ±namadÄ±");
                }
            } catch (error) {
                console.error("GÃ¶rsel API hatasÄ±:", error);
                sceneImageContainer.classList.add('hidden');
                
                // Character-specific error messages
                const charInfo = defaultCharacters[character] || customCharacters[character] || defaultCharacters['default'];
                let errorMessage = "ğŸŒ¸ GÃ¶rseli oluÅŸturamadÄ±m... Belki baÅŸka bir sahne fÄ±sÄ±ldar bana.";
                
                if (character === 'BilgeOgretmen') {
                    errorMessage = "ğŸ§™â€â™‚ï¸ GÃ¶rseli oluÅŸturmakta zorlandÄ±m. Bilgiyle yeniden deneyebiliriz.";
                } else if (character === 'KomikArkadas') {
                    errorMessage = "ğŸ˜„ Oops! GÃ¶rsel kaÃ§tÄ± gitti. Bir daha deneyelim mi?";
                } else if (character === 'TeknikUzman') {
                    errorMessage = "ğŸ”§ GÃ¶rsel API yanÄ±t vermedi. Offline modda Ã§alÄ±ÅŸÄ±yoruz.";
                } else if (character === 'DJPenguen') {
                    errorMessage = "ğŸ§ Beat dÃ¼ÅŸtÃ¼! GÃ¶rsel mix'i tekrar Ã§alÄ±ÅŸtÄ±ralÄ±m.";
                }
                
                showInlineError(errorMessage + " (API Offline)");
            }
        }

        // SVG encoding function for proper character handling
        function encodeSVG(svg) {
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }

        // Show inline error with character-themed messages
        function showInlineError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-xs sm:text-sm text-red-500 mt-2 text-center';
            errorDiv.textContent = message;

            const container = document.getElementById('sceneImageContainer');
            container.innerHTML = '';
            container.appendChild(errorDiv);
            container.classList.remove('hidden');

            setTimeout(() => {
                container.classList.add('hidden');
                container.innerHTML = '';
            }, 3000);
        }

        // Scene change listener
        document.getElementById('sceneSelect').addEventListener('change', function() {
            const selectedScene = this.value;
            const selectedCharacter = characterSelect.value;
            const charInfo = defaultCharacters[selectedCharacter] || customCharacters[selectedCharacter] || defaultCharacters['default'];
            
            applySceneTheme(selectedScene);
            
            // Add scene change message
            if (selectedScene) {
                addMessage(`ğŸ­ ${charInfo.emoji} Sahne "${selectedScene}" olarak deÄŸiÅŸtirildi...`, false);
            }
        });

        // Character sound function (Note: Audio not supported in Canva Code environment)
        function playCharacterSound(character) {
            const soundMap = {
                'RuzgarSairi': 'sound-rÃ¼zgar',
                'Kivilcim': 'sound-kÄ±vÄ±lcÄ±m',
                'ToprakAnne': 'sound-toprak',
                'SessizKodcu': 'sound-kodcu',
                'HayalPerdesi': 'sound-perde'
            };

            const soundId = soundMap[character];
            const audio = document.getElementById(soundId);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(error => {
                    console.log('Audio playback not supported in this environment');
                });
            }
        }

        // Make functions available globally
        window.deleteCharacter = deleteCharacter;
        window.triggerLogoGlow = triggerLogoGlow;
        window.generateSceneImage = generateSceneImage;
        window.encodeSVG = encodeSVG;
        window.showInlineError = showInlineError;
        window.applySceneTheme = applySceneTheme;
        window.playCharacterSound = playCharacterSound;
        window.installPWA = installPWA;
        window.dismissInstall = dismissInstall;
        window.updateDeploymentInfo = updateDeploymentInfo;
        window.testAPIConnection = testAPIConnection;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f0eef8b5d76055',t:'MTc2MDU0ODI2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>